<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring AI Agent</title>
    <script src="/marked.min.js"></script>
    <style>
        :root {
            --sidebar-w: 260px;
            --radius: 16px;
            --radius-sm: 10px;
        }

        /* Dark theme (default) */
        [data-theme="dark"] {
            --bg-main: #212121;
            --bg-sidebar: #171717;
            --bg-input: #2f2f2f;
            --bg-hover: #2f2f2f;
            --bg-user-msg: #303030;
            --text-primary: #ececec;
            --text-secondary: #b4b4b4;
            --text-muted: #8e8e8e;
            --accent: #10a37f;
            --accent-hover: #1a7f64;
            --border: #3e3e3e;
            --code-bg: rgba(255,255,255,0.08);
            --pre-bg: #1a1a1a;
            --scrollbar-thumb: #4a4a4a;
            --thinking-bg: rgba(255,255,255,0.05);
            --thinking-hover: rgba(255,255,255,0.08);
            --step-result-bg: rgba(255,255,255,0.03);
            --table-header-bg: rgba(255,255,255,0.05);
        }

        /* Light theme */
        [data-theme="light"] {
            --bg-main: #ffffff;
            --bg-sidebar: #f7f7f8;
            --bg-input: #f4f4f4;
            --bg-hover: #ececec;
            --bg-user-msg: #f4f4f4;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-muted: #8e8e8e;
            --accent: #10a37f;
            --accent-hover: #0d8c6d;
            --border: #e5e5e5;
            --code-bg: rgba(0,0,0,0.05);
            --pre-bg: #f6f6f6;
            --scrollbar-thumb: #c5c5c5;
            --thinking-bg: rgba(0,0,0,0.03);
            --thinking-hover: rgba(0,0,0,0.06);
            --step-result-bg: rgba(0,0,0,0.02);
            --table-header-bg: rgba(0,0,0,0.04);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Söhne', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* ===== Sidebar ===== */
        .sidebar {
            width: var(--sidebar-w);
            background: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            border-right: 1px solid var(--border);
            transition: transform 0.3s;
        }
        .sidebar-header {
            padding: 12px;
        }
        .new-chat-btn {
            width: 100%;
            padding: 10px 14px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .new-chat-btn:hover { background: var(--bg-hover); }
        .new-chat-btn svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2; }

        .sidebar-conversations {
            flex: 1;
            overflow-y: auto;
            padding: 4px 8px;
        }
        .conv-item {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background 0.15s;
            margin-bottom: 2px;
        }
        .conv-item:hover { background: var(--bg-hover); }
        .conv-item.active { background: var(--bg-hover); color: var(--text-primary); }

        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
        }

        /* ===== Main ===== */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* Top bar */
        .topbar {
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid transparent;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            position: relative;
            flex-shrink: 0;
        }
        .topbar .model-label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 8px;
            cursor: default;
        }
        .topbar .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
        }
        .sidebar-toggle {
            position: absolute;
            left: 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            display: none;
        }
        .sidebar-toggle:hover { background: var(--bg-hover); }

        /* Theme toggle */
        .theme-toggle {
            position: absolute;
            right: 12px;
            background: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s, border-color 0.2s;
        }
        .theme-toggle:hover {
            background: var(--bg-hover);
            border-color: var(--text-muted);
        }

        /* Chat area */
        .chat-scroll {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }

        .chat-container {
            max-width: 768px;
            margin: 0 auto;
            padding: 16px 24px 100px;
        }

        /* Welcome */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px 40px;
            text-align: center;
        }
        .welcome-icon {
            width: 56px;
            height: 56px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 20px;
        }
        .welcome h2 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .welcome p {
            font-size: 14px;
            color: var(--text-muted);
            max-width: 400px;
            line-height: 1.6;
        }

        /* Quick actions grid */
        .quick-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 600px;
            margin: 24px auto 0;
            padding: 0 20px;
        }
        .quick-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }
        .quick-card:hover {
            background: var(--bg-hover);
            border-color: var(--text-muted);
        }
        .quick-card .qc-icon { font-size: 18px; margin-bottom: 6px; }
        .quick-card .qc-title { font-size: 13px; font-weight: 500; color: var(--text-primary); }
        .quick-card .qc-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

        /* Messages */
        .msg-row {
            padding: 20px 0;
            animation: msgIn 0.35s ease;
        }
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg-row.user-row {
            display: flex;
            justify-content: flex-end;
        }
        .msg-row.user-row .msg-bubble {
            background: var(--bg-user-msg);
            border-radius: var(--radius) var(--radius) 4px var(--radius);
            padding: 12px 18px;
            max-width: 85%;
            font-size: 15px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .msg-row.assistant-row {
            display: flex;
            gap: 14px;
            align-items: flex-start;
        }
        .assistant-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .assistant-avatar svg {
            width: 18px;
            height: 18px;
            fill: #fff;
        }
        .assistant-body {
            flex: 1;
            min-width: 0;
        }

        /* Thinking / Plan collapsible */
        .thinking-block {
            margin-bottom: 8px;
        }
        .thinking-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--thinking-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-muted);
            cursor: pointer;
            transition: background 0.15s;
            user-select: none;
        }
        .thinking-toggle:hover { background: var(--thinking-hover); }
        .thinking-toggle .arrow {
            transition: transform 0.2s;
            font-size: 10px;
        }
        .thinking-toggle.open .arrow { transform: rotate(90deg); }
        .thinking-toggle .spinner-sm {
            width: 12px;
            height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .thinking-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-left: 4px;
            border-left: 2px solid var(--border);
            padding-left: 14px;
        }
        .thinking-content.open {
            max-height: 2000px;
            margin-top: 8px;
        }

        /* Plan steps inside thinking */
        .plan-steps {
            list-style: none;
            padding: 0;
            margin: 4px 0;
        }
        .plan-steps li {
            padding: 5px 0;
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .step-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .step-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }
        .plan-steps li.pending .step-icon { color: var(--text-muted); }
        .plan-steps li.running { color: var(--accent); }
        .plan-steps li.running .step-icon { color: var(--accent); }
        .plan-steps li.done { color: var(--accent); }
        .plan-steps li.done .step-icon { color: var(--accent); }

        .step-result {
            margin: 2px 0 2px 26px;
            padding: 6px 10px;
            background: var(--step-result-bg);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-muted);
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .step-result.show { display: block; }

        .observe-tag {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            margin: 2px 0 2px 26px;
        }
        .observe-tag.ok { color: var(--accent); background: rgba(16,163,127,0.1); }
        .observe-tag.replan { color: #f0a020; background: rgba(240,160,32,0.1); }

        .replan-banner {
            background: rgba(240,160,32,0.08);
            border: 1px solid rgba(240,160,32,0.25);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 6px 0;
            font-size: 12px;
            color: #f0a020;
        }
        .replan-banner strong { display: block; margin-bottom: 2px; }

        /* Result / Markdown content */
        .result-content {
            font-size: 15px;
            line-height: 1.7;
            color: var(--text-primary);
        }
        .result-content p { margin: 0.5em 0; }
        .result-content h1, .result-content h2, .result-content h3 {
            margin: 0.8em 0 0.3em;
            font-weight: 600;
        }
        .result-content h1 { font-size: 1.3em; }
        .result-content h2 { font-size: 1.15em; }
        .result-content h3 { font-size: 1.05em; }
        .result-content ul, .result-content ol { padding-left: 1.5em; margin: 0.4em 0; }
        .result-content li { margin: 0.25em 0; }
        .result-content code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.88em;
            font-family: 'Söhne Mono', 'Menlo', monospace;
        }
        .result-content pre {
            background: var(--pre-bg);
            padding: 14px 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.6em 0;
            border: 1px solid var(--border);
        }
        .result-content pre code {
            background: none;
            padding: 0;
            font-size: 13px;
            line-height: 1.5;
        }
        .result-content table {
            border-collapse: collapse;
            margin: 0.6em 0;
            width: 100%;
            font-size: 13px;
        }
        .result-content th, .result-content td {
            border: 1px solid var(--border);
            padding: 8px 12px;
            text-align: left;
        }
        .result-content th {
            background: var(--table-header-bg);
            font-weight: 600;
        }
        .result-content blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 12px;
            color: var(--text-secondary);
            margin: 0.5em 0;
        }
        .result-content strong { font-weight: 600; }
        .result-content a { color: var(--accent); text-decoration: none; }
        .result-content a:hover { text-decoration: underline; }

        /* ===== Input area ===== */
        .input-wrapper {
            padding: 0 24px 24px;
            max-width: 768px;
            margin: 0 auto;
            width: 100%;
        }
        .input-box {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            align-items: flex-end;
            padding: 8px 12px 8px 16px;
            transition: border-color 0.2s;
        }
        .input-box:focus-within {
            border-color: var(--text-muted);
        }
        .input-box textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            max-height: 150px;
            line-height: 1.5;
            padding: 6px 0;
        }
        .input-box textarea::placeholder { color: var(--text-muted); }
        .send-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: var(--accent);
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 8px;
            transition: background 0.2s, opacity 0.2s;
        }
        .send-btn:hover { background: var(--accent-hover); }
        .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .send-btn svg { width: 18px; height: 18px; fill: currentColor; }

        .input-hint {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* ===== Responsive ===== */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; z-index: 100; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .sidebar-toggle { display: block; }
            .quick-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <button class="new-chat-btn" onclick="newConversation()">
            <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            New Chat
        </button>
    </div>
    <div class="sidebar-conversations" id="convList"></div>
    <div class="sidebar-footer">Spring AI Agent &middot; SKILL.md + MCP</div>
</aside>

<!-- Main -->
<div class="main">
    <div class="topbar">
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <div class="model-label">
            <span class="status-dot"></span>
            Spring AI Agent
        </div>
        <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="切换主题">
            <span id="themeIcon">&#9790;</span>
        </button>
    </div>

    <div class="chat-scroll" id="chatScroll">
        <div class="chat-container" id="chatContainer">
            <div class="welcome" id="welcome">
                <div class="welcome-icon">AI</div>
                <h2>Spring AI Agent</h2>
                <p>SKILL.md 驱动的智能助手，支持天气查询、订单管理、数据分析等多种技能</p>
            </div>
            <div class="quick-grid" id="quickGrid">
                <div class="quick-card" onclick="sendQuick('上海今天天气怎么样？')">
                    <div class="qc-icon">&#9728;&#65039;</div>
                    <div class="qc-title">查天气</div>
                    <div class="qc-desc">上海今天天气怎么样？</div>
                </div>
                <div class="quick-card" onclick="sendQuick('帮我查一下张三的订单')">
                    <div class="qc-icon">&#128230;</div>
                    <div class="qc-title">查订单</div>
                    <div class="qc-desc">帮我查一下张三的订单</div>
                </div>
                <div class="quick-card" onclick="sendQuick('订单ORD20250201001帮我退款，质量问题')">
                    <div class="qc-icon">&#128176;</div>
                    <div class="qc-title">申请退款</div>
                    <div class="qc-desc">订单退款，质量问题</div>
                </div>
                <div class="quick-card" onclick="sendQuick('查一下ORD20250201002的物流')">
                    <div class="qc-icon">&#128666;</div>
                    <div class="qc-title">查物流</div>
                    <div class="qc-desc">查一下物流进度</div>
                </div>
                <div class="quick-card" onclick="sendQuick('统计一下各类商品的销售额')">
                    <div class="qc-icon">&#128202;</div>
                    <div class="qc-title">数据分析</div>
                    <div class="qc-desc">统计各类商品销售额</div>
                </div>
                <div class="quick-card" onclick="sendQuick('你好，你是谁？')">
                    <div class="qc-icon">&#128172;</div>
                    <div class="qc-title">闲聊</div>
                    <div class="qc-desc">你好，你是谁？</div>
                </div>
            </div>
        </div>
    </div>

    <div class="input-wrapper">
        <div class="input-box">
            <textarea id="messageInput" rows="1" placeholder="给 AI 发送消息..."
                      onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
        <div class="input-hint">Enter 发送 &middot; Shift+Enter 换行</div>
    </div>
</div>

<script>
    // ===== Theme =====
    function initTheme() {
        const saved = localStorage.getItem('theme') || 'dark';
        applyTheme(saved);
    }
    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        const icon = document.getElementById('themeIcon');
        if (icon) icon.innerHTML = theme === 'dark' ? '&#9790;' : '&#9728;&#65039;';
    }
    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme') || 'dark';
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        localStorage.setItem('theme', next);
    }
    initTheme();

    // ===== State =====
    let conversations = []; // { id, title, messages: [] }
    let currentConvId = null;
    let isLoading = false;

    // Init
    newConversation();

    // ===== Conversation Management =====
    function newConversation() {
        const id = crypto.randomUUID();
        conversations.push({ id, title: 'New Chat', messages: [] });
        currentConvId = id;
        renderConvList();
        clearChat();
    }

    function switchConversation(id) {
        currentConvId = id;
        renderConvList();
        replayConversation(id);
    }

    function renderConvList() {
        const list = document.getElementById('convList');
        list.innerHTML = conversations.slice().reverse().map(c =>
            `<div class="conv-item ${c.id === currentConvId ? 'active' : ''}"
                  onclick="switchConversation('${c.id}')"
                  title="${escapeHtml(c.title)}">${escapeHtml(c.title)}</div>`
        ).join('');
    }

    function replayConversation(id) {
        const conv = conversations.find(c => c.id === id);
        clearChat();
        if (!conv) return;
        conv.messages.forEach(m => {
            if (m.role === 'user') {
                appendUserMessage(m.content);
            } else {
                appendStaticAssistantMessage(m.content);
            }
        });
    }

    function clearChat() {
        const container = document.getElementById('chatContainer');
        container.innerHTML = '';
        const conv = conversations.find(c => c.id === currentConvId);
        if (!conv || conv.messages.length === 0) {
            container.innerHTML = `
                <div class="welcome" id="welcome">
                    <div class="welcome-icon">AI</div>
                    <h2>Spring AI Agent</h2>
                    <p>SKILL.md 驱动的智能助手，支持天气查询、订单管理、数据分析等多种技能</p>
                </div>
                <div class="quick-grid" id="quickGrid">
                    <div class="quick-card" onclick="sendQuick('上海今天天气怎么样？')">
                        <div class="qc-icon">&#9728;&#65039;</div>
                        <div class="qc-title">查天气</div>
                        <div class="qc-desc">上海今天天气怎么样？</div>
                    </div>
                    <div class="quick-card" onclick="sendQuick('帮我查一下张三的订单')">
                        <div class="qc-icon">&#128230;</div>
                        <div class="qc-title">查订单</div>
                        <div class="qc-desc">帮我查一下张三的订单</div>
                    </div>
                    <div class="quick-card" onclick="sendQuick('订单ORD20250201001帮我退款，质量问题')">
                        <div class="qc-icon">&#128176;</div>
                        <div class="qc-title">申请退款</div>
                        <div class="qc-desc">订单退款，质量问题</div>
                    </div>
                    <div class="quick-card" onclick="sendQuick('查一下ORD20250201002的物流')">
                        <div class="qc-icon">&#128666;</div>
                        <div class="qc-title">查物流</div>
                        <div class="qc-desc">查一下物流进度</div>
                    </div>
                    <div class="quick-card" onclick="sendQuick('统计一下各类商品的销售额')">
                        <div class="qc-icon">&#128202;</div>
                        <div class="qc-title">数据分析</div>
                        <div class="qc-desc">统计各类商品销售额</div>
                    </div>
                    <div class="quick-card" onclick="sendQuick('你好，你是谁？')">
                        <div class="qc-icon">&#128172;</div>
                        <div class="qc-title">闲聊</div>
                        <div class="qc-desc">你好，你是谁？</div>
                    </div>
                </div>`;
        }
    }

    // ===== Sidebar toggle (mobile) =====
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    // ===== Input =====
    function sendQuick(text) {
        document.getElementById('messageInput').value = text;
        sendMessage();
    }

    function handleKeyDown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = Math.min(el.scrollHeight, 150) + 'px';
    }

    // ===== Send =====
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message || isLoading) return;

        // Remove welcome
        const welcome = document.getElementById('welcome');
        if (welcome) welcome.remove();
        const quickGrid = document.getElementById('quickGrid');
        if (quickGrid) quickGrid.remove();

        // Update conversation title
        const conv = conversations.find(c => c.id === currentConvId);
        if (conv && conv.messages.length === 0) {
            conv.title = message.length > 30 ? message.substring(0, 30) + '...' : message;
            renderConvList();
        }

        appendUserMessage(message);
        conv.messages.push({ role: 'user', content: message });

        input.value = '';
        input.style.height = 'auto';
        isLoading = true;
        document.getElementById('sendBtn').disabled = true;

        const { thinkingBlock, resultContainer, messageRow } = appendAssistantMessage();
        let finalContent = '';

        try {
            const res = await fetch('/api/agent/chat/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'text/event-stream' },
                body: JSON.stringify({ conversationId: currentConvId, message })
            });

            if (!res.ok) {
                resultContainer.innerHTML = '<span style="color:#ef4444">请求失败: ' + res.status + '</span>';
                return;
            }

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });

                let boundary;
                while ((boundary = buffer.indexOf('\n\n')) !== -1) {
                    const block = buffer.substring(0, boundary);
                    buffer = buffer.substring(boundary + 2);

                    const lines = block.split('\n');
                    let raw = '';
                    for (const l of lines) {
                        if (l.startsWith('data:')) raw += l.slice(5);
                        else if (raw && l.trim()) raw += l;
                    }
                    raw = raw.trim();
                    if (!raw) continue;

                    try {
                        const event = JSON.parse(raw);
                        finalContent = handleEvent(event, thinkingBlock, resultContainer, finalContent);
                    } catch(e) {
                        console.warn('SSE parse error:', raw, e);
                    }
                }
            }
        } catch (err) {
            resultContainer.innerHTML = `<span style="color:#ef4444">网络错误: ${escapeHtml(err.message)}</span>`;
        } finally {
            // Finalize thinking block
            finishThinking(thinkingBlock);
            isLoading = false;
            document.getElementById('sendBtn').disabled = false;
            input.focus();
            if (conv && finalContent) {
                conv.messages.push({ role: 'assistant', content: finalContent });
            }
            scrollToBottom();
        }
    }

    // ===== Event Handler =====
    function handleEvent(event, thinkingBlock, resultContainer, finalContent) {
        const toggle = thinkingBlock.querySelector('.thinking-toggle');
        const content = thinkingBlock.querySelector('.thinking-content');

        switch (event.type) {
            case 'planning':
                updateThinkingLabel(toggle, event.message, true);
                // Auto-open thinking
                toggle.classList.add('open');
                content.classList.add('open');
                break;

            case 'plan':
                updateThinkingLabel(toggle, '执行计划', true);
                setPlanSteps(content, event.steps);
                break;

            case 'action':
                updateStepStatus(content, event.step, event.status, event.message, event.content);
                break;

            case 'observe':
                showObservation(content, event.step, event.message);
                break;

            case 'replan':
                showReplan(content, event.message, event.steps);
                break;

            case 'result':
                finalContent = event.content || '';
                resultContainer.innerHTML = renderMarkdown(finalContent);
                resultContainer.classList.add('result-content');
                // Collapse thinking
                toggle.classList.remove('open');
                content.classList.remove('open');
                break;

            case 'error':
                resultContainer.innerHTML = `<span style="color:#ef4444">${escapeHtml(event.message)}</span>`;
                break;

            case 'done':
                finishThinking(thinkingBlock);
                break;
        }

        scrollToBottom();
        return finalContent;
    }

    // ===== Thinking Block =====
    function updateThinkingLabel(toggle, text, spinning) {
        const spinnerHtml = spinning ? '<span class="spinner-sm"></span>' : '';
        toggle.innerHTML = `<span class="arrow">&#9654;</span> ${spinnerHtml} ${escapeHtml(text)}`;
        if (toggle.classList.contains('open')) {
            toggle.querySelector('.arrow').style.transform = 'rotate(90deg)';
        }
    }

    function finishThinking(thinkingBlock) {
        const toggle = thinkingBlock.querySelector('.thinking-toggle');
        const content = thinkingBlock.querySelector('.thinking-content');
        if (!toggle) return;
        // Remove spinner, keep label
        const spinners = toggle.querySelectorAll('.spinner-sm');
        spinners.forEach(s => s.remove());
        // If no plan steps, hide thinking block entirely
        if (!content.querySelector('.plan-steps')) {
            thinkingBlock.style.display = 'none';
        }
    }

    function setPlanSteps(contentEl, steps) {
        let stepsEl = contentEl.querySelector('.plan-steps');
        if (!stepsEl) {
            stepsEl = document.createElement('ul');
            stepsEl.className = 'plan-steps';
            contentEl.appendChild(stepsEl);
        }
        stepsEl.innerHTML = steps.map((s, i) =>
            `<li class="pending" data-step="${i + 1}">
                <div class="step-header">
                    <span class="step-icon">&#9675;</span>
                    <span>${escapeHtml(s)}</span>
                </div>
                <div class="step-result result-content"></div>
            </li>`
        ).join('');
    }

    function updateStepStatus(contentEl, stepNum, status, message, resultContent) {
        const li = contentEl.querySelector(`li[data-step="${stepNum}"]`);
        if (!li) return;

        if (status === 'running') {
            li.className = 'running';
            li.querySelector('.step-icon').innerHTML = '<span class="spinner-sm"></span>';
        } else if (status === 'done') {
            li.className = 'done';
            li.querySelector('.step-icon').innerHTML = '&#10003;';
            if (resultContent) {
                const resultEl = li.querySelector('.step-result');
                if (resultEl) {
                    const text = resultContent.length > 300 ? resultContent.substring(0, 300) + '...' : resultContent;
                    resultEl.innerHTML = renderMarkdown(text);
                    resultEl.classList.add('show');
                }
            }
        }
    }

    function showObservation(contentEl, stepNum, observation) {
        const li = contentEl.querySelector(`li[data-step="${stepNum}"]`);
        if (!li) return;
        const old = li.querySelector('.observe-tag');
        if (old) old.remove();
        const tag = document.createElement('div');
        const isOk = observation && observation.toUpperCase().startsWith('OK');
        tag.className = `observe-tag ${isOk ? 'ok' : 'replan'}`;
        tag.textContent = observation.length > 80 ? observation.substring(0, 80) + '...' : observation;
        li.appendChild(tag);
    }

    function showReplan(contentEl, reason, newSteps) {
        const banner = document.createElement('div');
        banner.className = 'replan-banner';
        banner.innerHTML = `<strong>&#128260; 重新规划</strong>${escapeHtml(reason.length > 80 ? reason.substring(0, 80) + '...' : reason)}`;
        contentEl.appendChild(banner);

        const oldSteps = contentEl.querySelector('.plan-steps');
        if (oldSteps) oldSteps.remove();

        const stepsEl = document.createElement('ul');
        stepsEl.className = 'plan-steps';
        stepsEl.innerHTML = newSteps.map((s, i) =>
            `<li class="pending" data-step="${i + 1}">
                <div class="step-header">
                    <span class="step-icon">&#9675;</span>
                    <span>${escapeHtml(s)}</span>
                </div>
                <div class="step-result result-content"></div>
            </li>`
        ).join('');
        contentEl.appendChild(stepsEl);
    }

    // ===== DOM Helpers =====
    function appendUserMessage(content) {
        const container = document.getElementById('chatContainer');
        const row = document.createElement('div');
        row.className = 'msg-row user-row';
        row.innerHTML = `<div class="msg-bubble">${escapeHtml(content)}</div>`;
        container.appendChild(row);
        scrollToBottom();
    }

    function appendAssistantMessage() {
        const container = document.getElementById('chatContainer');
        const row = document.createElement('div');
        row.className = 'msg-row assistant-row';

        row.innerHTML = `
            <div class="assistant-avatar">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            </div>
            <div class="assistant-body">
                <div class="thinking-block">
                    <div class="thinking-toggle" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
                        <span class="arrow">&#9654;</span>
                        <span class="spinner-sm"></span>
                        思考中...
                    </div>
                    <div class="thinking-content"></div>
                </div>
                <div class="assistant-result"></div>
            </div>
        `;

        container.appendChild(row);
        scrollToBottom();

        return {
            thinkingBlock: row.querySelector('.thinking-block'),
            resultContainer: row.querySelector('.assistant-result'),
            messageRow: row
        };
    }

    function appendStaticAssistantMessage(content) {
        const container = document.getElementById('chatContainer');
        const row = document.createElement('div');
        row.className = 'msg-row assistant-row';
        row.innerHTML = `
            <div class="assistant-avatar">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            </div>
            <div class="assistant-body">
                <div class="result-content">${renderMarkdown(content)}</div>
            </div>
        `;
        container.appendChild(row);
    }

    function scrollToBottom() {
        const scroll = document.getElementById('chatScroll');
        requestAnimationFrame(() => { scroll.scrollTop = scroll.scrollHeight; });
    }

    function renderMarkdown(text) {
        if (!text) return '';
        try {
            if (typeof marked !== 'undefined') {
                return marked.parse ? marked.parse(text) : marked(text);
            }
        } catch(e) { console.warn('marked error:', e); }
        return escapeHtml(text).replace(/\n/g, '<br>');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
</body>
</html>
