<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ³•å¾‹æ–‡ä»¶å¯¹æ¯”</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Helvetica Neue', sans-serif;
            background: #f5f6fa;
            color: #333;
            font-size: 14px;
            min-height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: #fff;
            padding: 14px 16px;
            text-align: center;
            font-size: 17px;
            font-weight: 600;
            letter-spacing: 1px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-section {
            padding: 12px;
        }
        .file-card {
            background: #fff;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .file-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .file-label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
        }
        .file-label.a { background: #3498db; }
        .file-label.b { background: #e67e22; }
        .file-card-header input {
            flex: 1;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }
        .file-card-header input:focus { border-color: #3498db; }
        .file-card textarea {
            width: 100%;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 10px;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            min-height: 120px;
            outline: none;
            transition: border-color 0.2s;
        }
        .file-card textarea:focus { border-color: #3498db; }
        .file-card .hint {
            font-size: 11px;
            color: #aaa;
            margin-top: 6px;
        }

        /* å¯¹æ¯”æŒ‰é’® */
        .compare-btn {
            display: block;
            width: calc(100% - 24px);
            margin: 4px 12px 16px;
            padding: 12px;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 2px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .compare-btn:active { opacity: 0.8; }

        /* ç»“æœåŒºåŸŸ */
        .result-section {
            display: none;
            padding: 0 12px 80px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat-card {
            flex: 1;
            background: #fff;
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .stat-card .num {
            font-size: 24px;
            font-weight: 700;
            line-height: 1.2;
        }
        .stat-card .label {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }
        .stat-card.added .num { color: #27ae60; }
        .stat-card.modified .num { color: #e67e22; }
        .stat-card.deleted .num { color: #e74c3c; }

        /* Tab åˆ‡æ¢ */
        .tabs {
            display: flex;
            background: #fff;
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .tab-btn {
            flex: 1;
            padding: 8px 4px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #999;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .tab-btn.active {
            background: #f0f7ff;
            color: #3498db;
            font-weight: 600;
        }
        .tab-btn .badge {
            display: inline-block;
            min-width: 16px;
            height: 16px;
            line-height: 16px;
            padding: 0 4px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            margin-left: 4px;
            vertical-align: middle;
        }
        .tab-btn.tab-full.active { background: #f0f0f5; color: #2c3e50; }
        .tab-btn.tab-added .badge { background: #27ae60; }
        .tab-btn.tab-modified .badge { background: #e67e22; }
        .tab-btn.tab-deleted .badge { background: #e74c3c; }

        /* å·®å¼‚åˆ—è¡¨ */
        .diff-panel { display: none; }
        .diff-panel.active { display: block; }

        .diff-item {
            background: #fff;
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .diff-item-header {
            padding: 10px 12px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .diff-item-header .tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
        }
        .diff-item.added .diff-item-header { background: #f0faf4; }
        .diff-item.added .tag { background: #27ae60; }
        .diff-item.modified .diff-item-header { background: #fef9f0; }
        .diff-item.modified .tag { background: #e67e22; }
        .diff-item.deleted .diff-item-header { background: #fdf0f0; }
        .diff-item.deleted .tag { background: #e74c3c; }

        .diff-item-body {
            padding: 10px 12px;
            font-size: 13px;
            line-height: 1.7;
        }
        .diff-item-body .old-text {
            background: #ffeaea;
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #e74c3c;
            color: #666;
        }
        .diff-item-body .new-text {
            background: #eafbf0;
            padding: 8px 10px;
            border-radius: 6px;
            border-left: 3px solid #27ae60;
            color: #333;
        }
        .diff-item-body .only-text {
            padding: 8px 10px;
            border-radius: 6px;
        }
        .diff-item.added .only-text {
            background: #eafbf0;
            border-left: 3px solid #27ae60;
        }
        .diff-item.deleted .only-text {
            background: #ffeaea;
            border-left: 3px solid #e74c3c;
            color: #999;
            text-decoration: line-through;
        }
        .diff-label {
            font-size: 11px;
            color: #999;
            margin-bottom: 4px;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #ccc;
        }
        .empty-state .icon { font-size: 40px; margin-bottom: 8px; }
        .empty-state .text { font-size: 13px; }

        /* é«˜äº®å·®å¼‚æ–‡å­— */
        .hl-add { background: #b8f0c8; padding: 1px 2px; border-radius: 2px; }
        .hl-del { background: #fcc; padding: 1px 2px; border-radius: 2px; text-decoration: line-through; }

        /* å…¨æ–‡å¯¹æ¯” */
        .fulltext-wrapper {
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .fulltext-header {
            display: flex;
            border-bottom: 1px solid #f0f0f0;
        }
        .fulltext-header .col-title {
            flex: 1;
            padding: 10px 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }
        .fulltext-header .col-title.old { background: #fdf5f5; color: #e74c3c; }
        .fulltext-header .col-title.new { background: #f0faf4; color: #27ae60; }
        .fulltext-row {
            display: flex;
            border-bottom: 1px solid #f8f8f8;
            min-height: 40px;
        }
        .fulltext-row:last-child { border-bottom: none; }
        .fulltext-cell {
            flex: 1;
            padding: 8px 10px;
            font-size: 12px;
            line-height: 1.6;
            word-break: break-all;
            border-right: 1px solid #f0f0f0;
        }
        .fulltext-cell:last-child { border-right: none; }
        .fulltext-cell.empty { background: #fafafa; color: #ccc; font-style: italic; }
        .fulltext-row.row-same .fulltext-cell { color: #999; }
        .fulltext-row.row-modified .fulltext-cell.old { background: #fff5f5; }
        .fulltext-row.row-modified .fulltext-cell.new { background: #f0fdf4; }
        .fulltext-row.row-added .fulltext-cell.old { background: #fafafa; }
        .fulltext-row.row-added .fulltext-cell.new { background: #eafbf0; }
        .fulltext-row.row-deleted .fulltext-cell.old { background: #ffeaea; }
        .fulltext-row.row-deleted .fulltext-cell.new { background: #fafafa; }
        .fulltext-row .row-tag {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 700;
            color: #fff;
            margin-right: 4px;
            vertical-align: middle;
        }
        .row-tag.tag-add { background: #27ae60; }
        .row-tag.tag-mod { background: #e67e22; }
        .row-tag.tag-del { background: #e74c3c; }
        .fulltext-legend {
            display: flex;
            gap: 12px;
            justify-content: center;
            padding: 8px;
            font-size: 11px;
            color: #999;
        }
        .fulltext-legend span::before {
            content: '';
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            margin-right: 4px;
            vertical-align: middle;
        }
        .legend-add::before { background: #eafbf0 !important; border: 1px solid #27ae60; }
        .legend-mod::before { background: #fff5f5 !important; border: 1px solid #e67e22; }
        .legend-del::before { background: #ffeaea !important; border: 1px solid #e74c3c; }
        .legend-same::before { background: #fff !important; border: 1px solid #ddd; }

        /* è¿”å›æŒ‰é’® */
        .back-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 32px;
            background: #fff;
            color: #3498db;
            border: 1.5px solid #3498db;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 50;
        }

        /* ç¤ºä¾‹æŒ‰é’® */
        .demo-btn {
            display: inline-block;
            padding: 4px 10px;
            background: #f0f7ff;
            color: #3498db;
            border: 1px solid #d4e8fc;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            margin-left: auto;
        }
    </style>
</head>
<body>

<div class="navbar">âš–ï¸ æ³•å¾‹æ–‡ä»¶å¯¹æ¯”å·¥å…·</div>

<!-- è¾“å…¥åŒºåŸŸ -->
<div class="input-section" id="inputSection">
    <div class="file-card">
        <div class="file-card-header">
            <span class="file-label a">A</span>
            <input type="text" id="nameA" placeholder="æ—§ç‰ˆæ–‡ä»¶åç§°ï¼Œå¦‚ï¼šXXæ³•ï¼ˆ2020ä¿®è®¢ï¼‰">
            <span class="demo-btn" onclick="loadDemo()">ç¤ºä¾‹</span>
        </div>
        <textarea id="textA" placeholder="ç²˜è´´æ—§ç‰ˆæ³•å¾‹æ–‡ä»¶å…¨æ–‡...&#10;&#10;æ ¼å¼å»ºè®®ï¼šæ¯æ¡/æ¯æ¬¾ç‹¬å ä¸€è¡Œï¼Œå¦‚ï¼š&#10;ç¬¬ä¸€æ¡ ä¸ºäº†ä¿æŠ¤ç¯å¢ƒ...&#10;ç¬¬äºŒæ¡ æœ¬æ³•æ‰€ç§°ç¯å¢ƒ..."></textarea>
        <div class="hint">ğŸ’¡ æ¯æ¡/æ¯æ¬¾ç‹¬å ä¸€è¡Œï¼Œç³»ç»ŸæŒ‰è¡ŒåŒ¹é…æ¡æ¬¾ç¼–å·è¿›è¡Œå¯¹æ¯”</div>
    </div>

    <div class="file-card">
        <div class="file-card-header">
            <span class="file-label b">B</span>
            <input type="text" id="nameB" placeholder="æ–°ç‰ˆæ–‡ä»¶åç§°ï¼Œå¦‚ï¼šXXæ³•ï¼ˆ2024ä¿®è®¢ï¼‰">
        </div>
        <textarea id="textB" placeholder="ç²˜è´´æ–°ç‰ˆæ³•å¾‹æ–‡ä»¶å…¨æ–‡..."></textarea>
    </div>

    <button class="compare-btn" onclick="doCompare()">å¼€å§‹å¯¹æ¯”</button>
</div>

<!-- ç»“æœåŒºåŸŸ -->
<div class="result-section" id="resultSection">
    <div class="stats-row">
        <div class="stat-card added">
            <div class="num" id="addedCount">0</div>
            <div class="label">æ–°å¢æ¡æ¬¾</div>
        </div>
        <div class="stat-card modified">
            <div class="num" id="modifiedCount">0</div>
            <div class="label">ä¿®æ”¹æ¡æ¬¾</div>
        </div>
        <div class="stat-card deleted">
            <div class="num" id="deletedCount">0</div>
            <div class="label">åˆ é™¤æ¡æ¬¾</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn tab-full active" data-tab="full" onclick="switchTab('full')">
            å…¨æ–‡
        </button>
        <button class="tab-btn tab-added" data-tab="added" onclick="switchTab('added')">
            æ–°å¢<span class="badge" id="addedBadge">0</span>
        </button>
        <button class="tab-btn tab-modified" data-tab="modified" onclick="switchTab('modified')">
            ä¿®æ”¹<span class="badge" id="modifiedBadge">0</span>
        </button>
        <button class="tab-btn tab-deleted" data-tab="deleted" onclick="switchTab('deleted')">
            åˆ é™¤<span class="badge" id="deletedBadge">0</span>
        </button>
    </div>

    <div class="diff-panel active" id="panel-full"></div>
    <div class="diff-panel" id="panel-added"></div>
    <div class="diff-panel" id="panel-modified"></div>
    <div class="diff-panel" id="panel-deleted"></div>

    <button class="back-btn" onclick="goBack()">â† è¿”å›ä¿®æ”¹</button>
</div>

<script>
    // ========== æ¡æ¬¾è§£æ ==========
    function parseClauses(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        const clauses = new Map(); // key â†’ content
        let currentKey = null;
        let currentContent = '';

        for (const line of lines) {
            const key = extractClauseKey(line);
            if (key) {
                if (currentKey) {
                    clauses.set(currentKey, currentContent.trim());
                }
                currentKey = key;
                currentContent = line;
            } else if (currentKey) {
                currentContent += '\n' + line;
            } else {
                // æ²¡æœ‰æ¡æ¬¾ç¼–å·çš„è¡Œï¼Œç”¨è¡Œå·ä½œä¸º key
                clauses.set('__line_' + clauses.size, line);
            }
        }
        if (currentKey) {
            clauses.set(currentKey, currentContent.trim());
        }
        return clauses;
    }

    function extractClauseKey(line) {
        // åŒ¹é…ï¼šç¬¬Xæ¡ã€ç¬¬Xæ¬¾ã€ç¬¬Xé¡¹ã€ç¬¬Xç« ã€ç¬¬XèŠ‚
        const m = line.match(/^(ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒé›¶\d]+[æ¡æ¬¾é¡¹ç« èŠ‚ç¼–])/);
        if (m) return m[1];
        // åŒ¹é…ï¼šä¸€ã€äºŒã€ä¸‰ã€... æˆ– ï¼ˆä¸€ï¼‰ï¼ˆäºŒï¼‰
        const m2 = line.match(/^([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+[ã€.]|ï¼ˆ[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ï¼‰)/);
        if (m2) return m2[1];
        // åŒ¹é…ï¼š1. 2. 3. æˆ– 1ã€2ã€
        const m3 = line.match(/^(\d+[.ã€])/);
        if (m3) return m3[1];
        return null;
    }

    // ========== å¯¹æ¯”é€»è¾‘ ==========
    function compareClauses(clausesA, clausesB) {
        const added = [];    // æ–°å¢ï¼šBæœ‰Aæ²¡æœ‰
        const modified = []; // ä¿®æ”¹ï¼šABéƒ½æœ‰ä½†å†…å®¹ä¸åŒ
        const deleted = [];  // åˆ é™¤ï¼šAæœ‰Bæ²¡æœ‰

        // æ£€æŸ¥ A ä¸­çš„æ¡æ¬¾
        for (const [key, contentA] of clausesA) {
            if (clausesB.has(key)) {
                const contentB = clausesB.get(key);
                if (normalizeText(contentA) !== normalizeText(contentB)) {
                    modified.push({ key, oldText: contentA, newText: contentB });
                }
            } else {
                deleted.push({ key, text: contentA });
            }
        }

        // æ£€æŸ¥ B ä¸­æ–°å¢çš„æ¡æ¬¾
        for (const [key, contentB] of clausesB) {
            if (!clausesA.has(key)) {
                added.push({ key, text: contentB });
            }
        }

        return { added, modified, deleted };
    }

    function normalizeText(text) {
        return text.replace(/\s+/g, '').replace(/[ï¼Œã€‚ï¼›ï¼šã€""''ï¼ˆï¼‰ã€ã€‘]/g, '');
    }

    // ========== æ–‡å­—å·®å¼‚é«˜äº® ==========
    function highlightDiff(oldText, newText) {
        const oldChars = oldText.split('');
        const newChars = newText.split('');
        const lcs = longestCommonSubsequence(oldChars, newChars);

        let oldHtml = '', newHtml = '';
        let oi = 0, ni = 0, li = 0;

        while (oi < oldChars.length || ni < newChars.length) {
            if (li < lcs.length && oi < oldChars.length && oldChars[oi] === lcs[li] &&
                ni < newChars.length && newChars[ni] === lcs[li]) {
                oldHtml += escapeHtml(oldChars[oi]);
                newHtml += escapeHtml(newChars[ni]);
                oi++; ni++; li++;
            } else {
                if (oi < oldChars.length && (li >= lcs.length || oldChars[oi] !== lcs[li])) {
                    oldHtml += '<span class="hl-del">' + escapeHtml(oldChars[oi]) + '</span>';
                    oi++;
                }
                if (ni < newChars.length && (li >= lcs.length || newChars[ni] !== lcs[li])) {
                    newHtml += '<span class="hl-add">' + escapeHtml(newChars[ni]) + '</span>';
                    ni++;
                }
            }
        }
        return { oldHtml, newHtml };
    }

    function longestCommonSubsequence(a, b) {
        const m = a.length, n = b.length;
        // é™åˆ¶é•¿åº¦é¿å…æ€§èƒ½é—®é¢˜
        if (m > 2000 || n > 2000) {
            return simpleLCS(a, b);
        }
        const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));
        for (let i = 1; i <= m; i++) {
            for (let j = 1; j <= n; j++) {
                dp[i][j] = a[i-1] === b[j-1] ? dp[i-1][j-1] + 1 : Math.max(dp[i-1][j], dp[i][j-1]);
            }
        }
        // å›æº¯
        const result = [];
        let i = m, j = n;
        while (i > 0 && j > 0) {
            if (a[i-1] === b[j-1]) { result.unshift(a[i-1]); i--; j--; }
            else if (dp[i-1][j] > dp[i][j-1]) { i--; }
            else { j--; }
        }
        return result;
    }

    function simpleLCS(a, b) {
        // ç®€åŒ–ç‰ˆï¼šæŒ‰è¯åŒ¹é…
        const setA = new Set(a);
        return b.filter(c => setA.has(c));
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ========== æ¸²æŸ“ç»“æœ ==========
    function renderResults(result) {
        // ç»Ÿè®¡
        document.getElementById('addedCount').textContent = result.added.length;
        document.getElementById('modifiedCount').textContent = result.modified.length;
        document.getElementById('deletedCount').textContent = result.deleted.length;
        document.getElementById('addedBadge').textContent = result.added.length;
        document.getElementById('modifiedBadge').textContent = result.modified.length;
        document.getElementById('deletedBadge').textContent = result.deleted.length;

        // æ–°å¢é¢æ¿
        const addedPanel = document.getElementById('panel-added');
        if (result.added.length === 0) {
            addedPanel.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“„</div><div class="text">æ— æ–°å¢æ¡æ¬¾</div></div>';
        } else {
            addedPanel.innerHTML = result.added.map(item =>
                `<div class="diff-item added">
                    <div class="diff-item-header">
                        <span class="tag">æ–°å¢</span>
                        <span>${escapeHtml(item.key.replace(/^__line_/, 'ç¬¬') + (item.key.startsWith('__line_') ? 'æ®µ' : ''))}</span>
                    </div>
                    <div class="diff-item-body">
                        <div class="only-text">${escapeHtml(item.text)}</div>
                    </div>
                </div>`
            ).join('');
        }

        // ä¿®æ”¹é¢æ¿
        const modifiedPanel = document.getElementById('panel-modified');
        if (result.modified.length === 0) {
            modifiedPanel.innerHTML = '<div class="empty-state"><div class="icon">âœï¸</div><div class="text">æ— ä¿®æ”¹æ¡æ¬¾</div></div>';
        } else {
            modifiedPanel.innerHTML = result.modified.map(item => {
                const diff = highlightDiff(item.oldText, item.newText);
                return `<div class="diff-item modified">
                    <div class="diff-item-header">
                        <span class="tag">ä¿®æ”¹</span>
                        <span>${escapeHtml(item.key)}</span>
                    </div>
                    <div class="diff-item-body">
                        <div class="diff-label">ğŸ“• æ—§ç‰ˆï¼ˆ${nameA()}ï¼‰</div>
                        <div class="old-text">${diff.oldHtml}</div>
                        <div class="diff-label" style="margin-top:8px">ğŸ“— æ–°ç‰ˆï¼ˆ${nameB()}ï¼‰</div>
                        <div class="new-text">${diff.newHtml}</div>
                    </div>
                </div>`;
            }).join('');
        }

        // åˆ é™¤é¢æ¿
        const deletedPanel = document.getElementById('panel-deleted');
        if (result.deleted.length === 0) {
            deletedPanel.innerHTML = '<div class="empty-state"><div class="icon">ğŸ—‘ï¸</div><div class="text">æ— åˆ é™¤æ¡æ¬¾</div></div>';
        } else {
            deletedPanel.innerHTML = result.deleted.map(item =>
                `<div class="diff-item deleted">
                    <div class="diff-item-header">
                        <span class="tag">åˆ é™¤</span>
                        <span>${escapeHtml(item.key.replace(/^__line_/, 'ç¬¬') + (item.key.startsWith('__line_') ? 'æ®µ' : ''))}</span>
                    </div>
                    <div class="diff-item-body">
                        <div class="only-text">${escapeHtml(item.text)}</div>
                    </div>
                </div>`
            ).join('');
        }
    }

    function nameA() { return escapeHtml(document.getElementById('nameA').value || 'æ–‡ä»¶A'); }
    function nameB() { return escapeHtml(document.getElementById('nameB').value || 'æ–‡ä»¶B'); }

    // ========== Tab åˆ‡æ¢ ==========
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('active');
        document.querySelectorAll('.diff-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('panel-' + tab).classList.add('active');
    }

    // ========== ä¸»æµç¨‹ ==========
    function doCompare() {
        const textA = document.getElementById('textA').value.trim();
        const textB = document.getElementById('textB').value.trim();

        if (!textA || !textB) {
            alert('è¯·è¾“å…¥ä¸¤ä»½æ³•å¾‹æ–‡ä»¶å†…å®¹');
            return;
        }

        const clausesA = parseClauses(textA);
        const clausesB = parseClauses(textB);
        const result = compareClauses(clausesA, clausesB);

        renderResults(result);

        document.getElementById('inputSection').style.display = 'none';
        document.getElementById('resultSection').style.display = 'block';
        renderFullText(clausesA, clausesB, result);
        switchTab('full');
        window.scrollTo(0, 0);
    }

    function goBack() {
        document.getElementById('inputSection').style.display = 'block';
        document.getElementById('resultSection').style.display = 'none';
        window.scrollTo(0, 0);
    }

    // ========== å…¨æ–‡å¯¹æ¯”æ¸²æŸ“ ==========
    function renderFullText(clausesA, clausesB, result) {
        const addedKeys = new Set(result.added.map(i => i.key));
        const modifiedKeys = new Set(result.modified.map(i => i.key));
        const deletedKeys = new Set(result.deleted.map(i => i.key));

        // åˆå¹¶æ‰€æœ‰ keyï¼Œä¿æŒé¡ºåº
        const allKeys = [];
        const seenKeys = new Set();
        for (const key of clausesA.keys()) {
            allKeys.push(key);
            seenKeys.add(key);
        }
        for (const key of clausesB.keys()) {
            if (!seenKeys.has(key)) {
                // æ‰¾åˆ°åœ¨ B ä¸­çš„ä½ç½®ï¼Œæ’å…¥åˆ°åˆé€‚ä½ç½®
                allKeys.push(key);
            }
        }

        let html = '<div class="fulltext-legend">';
        html += '<span class="legend-same">æœªå˜</span>';
        html += '<span class="legend-add">æ–°å¢</span>';
        html += '<span class="legend-mod">ä¿®æ”¹</span>';
        html += '<span class="legend-del">åˆ é™¤</span>';
        html += '</div>';
        html += '<div class="fulltext-wrapper">';
        html += '<div class="fulltext-header">';
        html += `<div class="col-title old">ğŸ“• ${nameA()}</div>`;
        html += `<div class="col-title new">ğŸ“— ${nameB()}</div>`;
        html += '</div>';

        for (const key of allKeys) {
            const inA = clausesA.has(key);
            const inB = clausesB.has(key);
            const contentA = inA ? clausesA.get(key) : '';
            const contentB = inB ? clausesB.get(key) : '';

            let rowClass = 'row-same';
            let tagHtml = '';
            let cellAHtml = escapeHtml(contentA);
            let cellBHtml = escapeHtml(contentB);

            if (addedKeys.has(key)) {
                rowClass = 'row-added';
                tagHtml = '<span class="row-tag tag-add">æ–°å¢</span>';
                cellAHtml = '<span style="color:#ccc">â€”</span>';
            } else if (deletedKeys.has(key)) {
                rowClass = 'row-deleted';
                tagHtml = '<span class="row-tag tag-del">åˆ é™¤</span>';
                cellBHtml = '<span style="color:#ccc">â€”</span>';
            } else if (modifiedKeys.has(key)) {
                rowClass = 'row-modified';
                tagHtml = '<span class="row-tag tag-mod">ä¿®æ”¹</span>';
                const diff = highlightDiff(contentA, contentB);
                cellAHtml = diff.oldHtml;
                cellBHtml = diff.newHtml;
            }

            html += `<div class="fulltext-row ${rowClass}">`;
            html += `<div class="fulltext-cell old">${rowClass !== 'row-added' ? cellAHtml : cellAHtml}</div>`;
            html += `<div class="fulltext-cell new">${tagHtml}${cellBHtml}</div>`;
            html += '</div>';
        }

        html += '</div>';
        document.getElementById('panel-full').innerHTML = html;
    }

    // ========== ç¤ºä¾‹æ•°æ® ==========
    function loadDemo() {
        document.getElementById('nameA').value = 'æ•°æ®å®‰å…¨æ³•ï¼ˆ2021ï¼‰';
        document.getElementById('nameB').value = 'æ•°æ®å®‰å…¨æ³•ï¼ˆ2024ä¿®è®¢ï¼‰';
        document.getElementById('textA').value =
`ç¬¬ä¸€æ¡ ä¸ºäº†è§„èŒƒæ•°æ®å¤„ç†æ´»åŠ¨ï¼Œä¿éšœæ•°æ®å®‰å…¨ï¼Œä¿ƒè¿›æ•°æ®å¼€å‘åˆ©ç”¨ï¼Œä¿æŠ¤ä¸ªäººã€ç»„ç»‡çš„åˆæ³•æƒç›Šï¼Œç»´æŠ¤å›½å®¶ä¸»æƒã€å®‰å…¨å’Œå‘å±•åˆ©ç›Šï¼Œåˆ¶å®šæœ¬æ³•ã€‚
ç¬¬äºŒæ¡ åœ¨ä¸­åäººæ°‘å…±å’Œå›½å¢ƒå†…å¼€å±•æ•°æ®å¤„ç†æ´»åŠ¨åŠå…¶å®‰å…¨ç›‘ç®¡ï¼Œé€‚ç”¨æœ¬æ³•ã€‚
ç¬¬ä¸‰æ¡ æœ¬æ³•æ‰€ç§°æ•°æ®ï¼Œæ˜¯æŒ‡ä»»ä½•ä»¥ç”µå­æˆ–è€…å…¶ä»–æ–¹å¼å¯¹ä¿¡æ¯çš„è®°å½•ã€‚æ•°æ®å¤„ç†ï¼ŒåŒ…æ‹¬æ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€ä½¿ç”¨ã€åŠ å·¥ã€ä¼ è¾“ã€æä¾›ã€å…¬å¼€ç­‰ã€‚æ•°æ®å®‰å…¨ï¼Œæ˜¯æŒ‡é€šè¿‡é‡‡å–å¿…è¦æªæ–½ï¼Œç¡®ä¿æ•°æ®å¤„äºæœ‰æ•ˆä¿æŠ¤å’Œåˆæ³•åˆ©ç”¨çš„çŠ¶æ€ï¼Œä»¥åŠå…·å¤‡ä¿éšœæŒç»­å®‰å…¨çŠ¶æ€çš„èƒ½åŠ›ã€‚
ç¬¬å››æ¡ ç»´æŠ¤æ•°æ®å®‰å…¨ï¼Œåº”å½“åšæŒæ€»ä½“å›½å®¶å®‰å…¨è§‚ï¼Œå»ºç«‹å¥å…¨æ•°æ®å®‰å…¨æ²»ç†ä½“ç³»ï¼Œæé«˜æ•°æ®å®‰å…¨ä¿éšœèƒ½åŠ›ã€‚
ç¬¬äº”æ¡ ä¸­å¤®å›½å®¶å®‰å…¨é¢†å¯¼æœºæ„è´Ÿè´£å›½å®¶æ•°æ®å®‰å…¨å·¥ä½œçš„å†³ç­–å’Œè®®äº‹åè°ƒï¼Œç ”ç©¶åˆ¶å®šã€æŒ‡å¯¼å®æ–½å›½å®¶æ•°æ®å®‰å…¨æˆ˜ç•¥å’Œæœ‰å…³é‡å¤§æ–¹é’ˆæ”¿ç­–ã€‚
ç¬¬å…­æ¡ å„åœ°åŒºã€å„éƒ¨é—¨å¯¹æœ¬åœ°åŒºã€æœ¬éƒ¨é—¨å·¥ä½œä¸­æ”¶é›†å’Œäº§ç”Ÿçš„æ•°æ®åŠæ•°æ®å®‰å…¨è´Ÿè´£ã€‚
ç¬¬ä¸ƒæ¡ å›½å®¶ä¿æŠ¤ä¸ªäººã€ç»„ç»‡ä¸æ•°æ®æœ‰å…³çš„æƒç›Šï¼Œé¼“åŠ±æ•°æ®ä¾æ³•åˆç†æœ‰æ•ˆåˆ©ç”¨ï¼Œä¿éšœæ•°æ®ä¾æ³•æœ‰åºè‡ªç”±æµåŠ¨ï¼Œä¿ƒè¿›ä»¥æ•°æ®ä¸ºå…³é”®è¦ç´ çš„æ•°å­—ç»æµå‘å±•ã€‚`;

        document.getElementById('textB').value =
`ç¬¬ä¸€æ¡ ä¸ºäº†è§„èŒƒæ•°æ®å¤„ç†æ´»åŠ¨ï¼Œä¿éšœæ•°æ®å®‰å…¨ï¼Œä¿ƒè¿›æ•°æ®å¼€å‘åˆ©ç”¨ï¼Œä¿æŠ¤ä¸ªäººã€ç»„ç»‡çš„åˆæ³•æƒç›Šï¼Œç»´æŠ¤å›½å®¶ä¸»æƒã€å®‰å…¨å’Œå‘å±•åˆ©ç›Šï¼Œæ¨åŠ¨æ•°å­—ç»æµé«˜è´¨é‡å‘å±•ï¼Œåˆ¶å®šæœ¬æ³•ã€‚
ç¬¬äºŒæ¡ åœ¨ä¸­åäººæ°‘å…±å’Œå›½å¢ƒå†…å¼€å±•æ•°æ®å¤„ç†æ´»åŠ¨åŠå…¶å®‰å…¨ç›‘ç®¡ï¼Œé€‚ç”¨æœ¬æ³•ã€‚åœ¨ä¸­åäººæ°‘å…±å’Œå›½å¢ƒå¤–å¼€å±•æ•°æ®å¤„ç†æ´»åŠ¨ï¼ŒæŸå®³ä¸­åäººæ°‘å…±å’Œå›½å›½å®¶å®‰å…¨ã€å…¬å…±åˆ©ç›Šæˆ–è€…å…¬æ°‘ã€ç»„ç»‡åˆæ³•æƒç›Šçš„ï¼Œä¾æ³•è¿½ç©¶æ³•å¾‹è´£ä»»ã€‚
ç¬¬ä¸‰æ¡ æœ¬æ³•æ‰€ç§°æ•°æ®ï¼Œæ˜¯æŒ‡ä»»ä½•ä»¥ç”µå­æˆ–è€…å…¶ä»–æ–¹å¼å¯¹ä¿¡æ¯çš„è®°å½•ã€‚æ•°æ®å¤„ç†ï¼ŒåŒ…æ‹¬æ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€ä½¿ç”¨ã€åŠ å·¥ã€ä¼ è¾“ã€æä¾›ã€å…¬å¼€ç­‰ã€‚æ•°æ®å®‰å…¨ï¼Œæ˜¯æŒ‡é€šè¿‡é‡‡å–å¿…è¦æªæ–½ï¼Œç¡®ä¿æ•°æ®å¤„äºæœ‰æ•ˆä¿æŠ¤å’Œåˆæ³•åˆ©ç”¨çš„çŠ¶æ€ï¼Œä»¥åŠå…·å¤‡ä¿éšœæŒç»­å®‰å…¨çŠ¶æ€çš„èƒ½åŠ›ã€‚
ç¬¬å››æ¡ ç»´æŠ¤æ•°æ®å®‰å…¨ï¼Œåº”å½“åšæŒæ€»ä½“å›½å®¶å®‰å…¨è§‚ï¼Œå»ºç«‹å¥å…¨æ•°æ®å®‰å…¨æ²»ç†ä½“ç³»ï¼Œæé«˜æ•°æ®å®‰å…¨ä¿éšœèƒ½åŠ›ã€‚
ç¬¬äº”æ¡ ä¸­å¤®å›½å®¶å®‰å…¨é¢†å¯¼æœºæ„è´Ÿè´£å›½å®¶æ•°æ®å®‰å…¨å·¥ä½œçš„å†³ç­–å’Œè®®äº‹åè°ƒï¼Œç ”ç©¶åˆ¶å®šã€æŒ‡å¯¼å®æ–½å›½å®¶æ•°æ®å®‰å…¨æˆ˜ç•¥å’Œæœ‰å…³é‡å¤§æ–¹é’ˆæ”¿ç­–ã€‚
ç¬¬ä¸ƒæ¡ å›½å®¶ä¿æŠ¤ä¸ªäººã€ç»„ç»‡ä¸æ•°æ®æœ‰å…³çš„æƒç›Šï¼Œé¼“åŠ±æ•°æ®ä¾æ³•åˆç†æœ‰æ•ˆåˆ©ç”¨ï¼Œä¿éšœæ•°æ®ä¾æ³•æœ‰åºè‡ªç”±æµåŠ¨ï¼Œä¿ƒè¿›ä»¥æ•°æ®ä¸ºå…³é”®è¦ç´ çš„æ•°å­—ç»æµå‘å±•ã€‚
ç¬¬å…«æ¡ å›½å®¶å»ºç«‹æ•°æ®åˆ†ç±»åˆ†çº§ä¿æŠ¤åˆ¶åº¦ï¼Œæ ¹æ®æ•°æ®åœ¨ç»æµç¤¾ä¼šå‘å±•ä¸­çš„é‡è¦ç¨‹åº¦ï¼Œä»¥åŠä¸€æ—¦é­åˆ°ç¯¡æ”¹ã€ç ´åã€æ³„éœ²æˆ–è€…éæ³•è·å–ã€éæ³•åˆ©ç”¨ï¼Œå¯¹å›½å®¶å®‰å…¨ã€å…¬å…±åˆ©ç›Šæˆ–è€…ä¸ªäººã€ç»„ç»‡åˆæ³•æƒç›Šé€ æˆçš„å±å®³ç¨‹åº¦ï¼Œå¯¹æ•°æ®å®è¡Œåˆ†ç±»åˆ†çº§ä¿æŠ¤ã€‚`;
    }
</script>

</body>
</html>
